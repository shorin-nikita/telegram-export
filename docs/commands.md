# Подробное описание команд

## setup

Интерактивная первоначальная настройка. Выполняет два шага:

1. **Создание `.env`** — запрашивает `API_ID` и `API_HASH`, имя сессии и папку экспорта
2. **Авторизация** — подключается к Telegram и запрашивает номер телефона + код

```bash
tg-export setup
```

Если `.env` уже существует, спросит подтверждение перед перезаписью.

## auth

Авторизация (или переавторизация) в Telegram. Используйте, если сессия истекла.

```bash
tg-export auth
```

Требует наличия `.env` с `API_ID` и `API_HASH`.

## export

Универсальный экспорт сообщений. Работает с любым типом источника.

```bash
tg-export export <source> [--format json|txt|md] [--output FILE] [--topic ID] [--media] [--days N]
```

### Логика работы

1. Парсит источник (URL, username, телефон, ID)
2. Подключается к Telegram и получает сущность
3. Итерирует все сообщения (или за последние N дней)
4. Если `--media` — скачивает фото, видео, документы
5. Сохраняет в указанном формате

### Форматы

- **json** — полная структура с метаданными, подходит для `update` и `analyze`
- **txt** — простой текст: `[дата] Имя: текст`
- **md** — Markdown с форматированием и ссылками на медиа

### Примечания

- Медиа скачиваются только для фото (`MessageMediaPhoto`) и документов (`MessageMediaDocument`)
- `--days` фильтрует по дате сообщения (UTC)
- `--topic` работает для форумных групп

## update

Инкрементальное обновление: загружает только новые сообщения (с ID больше последнего в файле).

```bash
tg-export update <path.json> [--no-media]
```

### Логика работы

1. Читает JSON-файл, находит последний `id` сообщения
2. Загружает сообщения с `min_id = last_id`
3. Скачивает медиа (если не `--no-media`)
4. Дописывает новые сообщения в тот же файл
5. Обновляет `total_messages` и `export_date`

### Совместимость

Работает с файлами, содержащими как `entity_info`, так и `chat_info`.

## download-media

Находит сообщения, у которых `media_file` заполнен, но файл отсутствует на диске.

```bash
tg-export download-media <path.json>
```

Скачивает каждый файл отдельно через API. Пауза каждые 10 файлов для избежания rate limit.

## analyze

Офлайн-анализ без подключения к Telegram. Работает только с JSON-файлом.

```bash
tg-export analyze <path.json> [--output report.md]
```

### Генерирует

1. `*_analysis.json` — сырые аналитические данные
2. `*_report.md` — форматированный Markdown-отчет

### Разделы отчета

1. **Общая статистика** — сообщения, участники, топики, период
2. **Участники** — топ-20 по активности, реакции, ответы
3. **Топики/треды** — группировка по цепочкам reply_to
4. **Временной анализ** — часы, дни, месяцы, стрики
5. **Контент** — типы, слова, ссылки, эмодзи
6. **Вовлеченность** — реакции, просмотры, пересылки

## channel-check

Проверяет, является ли пользователь владельцем канала.

```bash
tg-export channel-check <user>
```

### Алгоритм поиска

1. Быстрая проверка канала с тем же username
2. Проверка `linked_chat_id` в профиле пользователя
3. Полный перебор диалогов (если первые два шага не дали результат)

## channel-export

Экспорт всех постов канала в JSON и TXT. Включает информацию о подписчиках.

```bash
tg-export channel-export <channel>
```

Создает два файла: `messages_TIMESTAMP.json` и `messages_TIMESTAMP.txt`.

## channel-stats

Полная аналитика канала с подключением к Telegram.

```bash
tg-export channel-stats <channel>
```

### Генерирует

- `stats_TIMESTAMP.txt` — текстовый отчет
- `stats_TIMESTAMP.json` — полные данные с каждым постом

### Включает

- Общую статистику (просмотры, пересылки, реакции)
- Средние значения на пост
- Топ-20 постов по просмотрам, пересылкам и реакциям
- Распределение по месяцам
- Типы медиа и реакций
